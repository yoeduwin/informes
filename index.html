<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gesti√≥n de Expedientes - Ejecutiva Ambiental</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #1e5a3e;
      --secondary: #2d7a4f;
      --accent: #27ae60;
      --dark: #2c3e50;
      --muted: #7f8c8d;
      --bg: #f5f5f5;
      --border: #e0e0e0;
      --danger: #dc3545;
      --warning: #ffc107;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: #333;
      font-size: 13px;
      line-height: 1.6;
    }

    /* TABS NAV */
    .tabs-container {
      background: white;
      border-bottom: 2px solid var(--border);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .tabs {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 0;
    }
    .tab {
      padding: 1.2rem 2.5rem;
      cursor: pointer;
      border: none;
      border-bottom: 3px solid transparent;
      background: transparent;
      transition: all 0.3s;
      font-weight: bold;
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tab:hover { background: #f8f9fa; color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

    .content { max-width: 1400px; margin: 0 auto; padding: 0 20px 40px 20px; }
    .section-tab { display: none; animation: fadeIn 0.3s ease; }
    .section-tab.active { display: block; }

    /* =========================================================
       NUEVO EXPEDIENTE (DISE√ëO EA)
       ========================================================= */
    .ea-main-container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .ea-header {
      background: linear-gradient(135deg, #1e5a3e, #2d7a4f);
      color: #fff;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ea-logo-section { display: flex; align-items: center; gap: 15px; }
    .ea-logo {
      width: 50px; height: 50px; background: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #1e5a3e; font-weight: bold; font-size: 20px;
    }
    .ea-company-info h1 { margin: 0; font-size: 18px; font-weight: bold; }
    .ea-company-info p { margin: 3px 0 0 0; font-size: 10px; opacity: .95; }
    .ea-document-info h2 { margin: 0; font-size: 22px; font-weight: bold; text-align: right; }
    .ea-document-info p { margin: 3px 0 0 0; font-size: 11px; opacity: .9; text-align: right; }

    .ea-form-content { padding: 30px 40px; }
    
    .ea-section {
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 30px;
      padding-bottom: 25px;
      transition: all 0.3s ease;
    }
    .ea-section:last-child { border-bottom: none; }
    
    .step-locked {
      opacity: 0.4;
      pointer-events: none;
      filter: grayscale(100%);
    }

    .ea-section-header {
      background: #1e5a3e;
      color: #fff;
      padding: 10px 20px;
      margin: 0 -40px 25px -40px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ea-step-badge {
      background: rgba(255,255,255,0.2);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 10px;
    }

    .ea-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .ea-form-group { display: flex; flex-direction: column; }
    .ea-form-group.full-width { grid-column: 1 / -1; }
    
    .ea-label { font-weight: bold; color: #333; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; }
    .ea-required { color: #dc3545; margin-left: 3px; font-size: 14px; }
    
    .ea-input, .ea-select {
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 12px;
      border-radius: 3px;
      background: #f9f9f9;
      font-family: inherit;
      transition: all .2s;
    }
    .ea-input:focus, .ea-select:focus {
      outline: none;
      border-color: #1e5a3e;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(30,90,62,.1);
    }
    .ea-input[readonly] { background: #e8f5e9; border-color: #a5d6a7; color: #1e5a3e; font-weight: bold; }

    .ea-file-zone {
      border: 2px dashed #ccc;
      border-radius: 5px;
      padding: 15px;
      background: #fafafa;
      transition: all .3s;
      cursor: pointer;
    }
    .ea-file-zone:hover { border-color: #1e5a3e; background: #f0f9f4; }
    .ea-file-zone input[type="file"] { width: 100%; cursor: pointer; font-size: 11px; }
    .ea-helper-text { font-size: 10px; color: #666; margin-top: 4px; font-style: italic; }

    .ea-btn-submit {
      background: linear-gradient(135deg, #1e5a3e, #2d7a4f);
      color: white;
      padding: 15px 50px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all .3s ease;
      box-shadow: 0 4px 15px rgba(30,90,62,.3);
      text-transform: uppercase;
      letter-spacing: .5px;
      width: 100%;
      margin-top: 20px;
    }
    .ea-btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30,90,62,.4); }
    .ea-btn-submit:disabled { opacity: .6; cursor: not-allowed; transform: none; box-shadow: none;}

    .excel-cell-indicator {
      display: inline-block;
      background: #e1f5fe; color: #0288d1;
      padding: 2px 6px; border-radius: 3px;
      font-size: 9px; font-weight: bold; font-family: monospace;
      margin-left: 5px;
      text-transform: none;
    }

    .status-box { padding: 15px; border-radius: 5px; margin-top: 10px; font-size: 12px; font-weight: bold; }
    .box-warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
    .box-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }

    /* =========================================================
       TABLERO DE INFORMES
       ========================================================= */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .kpi-card { background: white; padding: 1.2rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-left: 4px solid var(--border); }
    .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: bold;}
    .kpi-value { font-size: 24px; font-weight: bold; color: var(--dark); margin: 5px 0;}
    
    .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header { padding: 1.2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: var(--dark); position: sticky; top: 0; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--dark); }
    tr:hover { background: #f8f9fa; }
    
    .chip { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase;}
    .chip-green { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;}
    .chip-yellow { background: #fff8e1; color: #f39c12; border: 1px solid #ffecb3;}
    .chip-red { background: #fbeeee; color: #c0392b; border: 1px solid #fadbd8;}
    .chip-gray { background: #f0f3f4; color: #7f8c8d; border: 1px solid #dfe6e9;}

    .filter-bar { display: flex; gap: 1rem; padding: 15px; background: #f8f9fa; border-bottom: 1px solid var(--border); }
    .filter-bar input, .filter-bar select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    
    .loader { display: none; text-align: center; padding: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
      .ea-form-grid { grid-template-columns: 1fr; }
      .ea-header { flex-direction: column; text-align: center; gap: 15px; }
      .ea-document-info h2, .ea-document-info p { text-align: center; }
      .ea-form-content { padding: 20px; }
      .ea-section-header { margin: 0 -20px 20px -20px; }
      .filter-bar { flex-direction: column; }
    }
  </style>
</head>

<body>

  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" onclick="changeTab('nuevo', event)">‚ûï Nuevo Expediente</button>
      <button class="tab" onclick="changeTab('tablero', event)">üìã Tablero de Informes</button>
    </div>
  </div>

  <div class="content">
    
    <div id="section-nuevo" class="section-tab active">
      
      <div class="ea-main-container">
        
        <div class="ea-header">
          <div class="ea-logo-section">
            <div class="ea-logo">EA</div>
            <div class="ea-company-info">
              <h1>EJECUTIVA AMBIENTAL</h1>
              <p>SISTEMA DE GESTI√ìN OPERATIVA Y EXPEDIENTES</p>
            </div>
          </div>
          <div class="ea-document-info">
            <h2>NUEVO EXPEDIENTE</h2>
            <p>Registro de Informes</p>
          </div>
        </div>

        <div class="ea-form-content">
          
          <div class="ea-section" id="card-paso1">
            <div class="ea-section-header">
              <span class="ea-step-badge">PASO 1</span> PERFIL DE DATOS DEL CLIENTE
            </div>
            
            <div class="ea-form-grid">
              <div class="ea-form-group full-width">
                <label class="ea-label">Archivo Excel del Cliente (.xlsx, .xls) <span class="ea-required">*</span></label>
                <div class="ea-file-zone">
                  <input type="file" id="excelFile" accept=".xlsx, .xls">
                  <div class="ea-helper-text" style="margin-top: 8px;">Arrastra o selecciona el archivo para extraer los datos autom√°ticamente</div>
                </div>
              </div>
            </div>

            <div id="perfil-status-box" class="status-box box-warning">
              <span id="info-perfil-quick">‚ö†Ô∏è Sin cargar - Sube el Excel para desbloquear los siguientes pasos.</span>
            </div>
          </div>

          <div class="ea-section step-locked" id="card-paso2">
            <div class="ea-section-header">
              <span class="ea-step-badge">PASO 2</span> INFORMACI√ìN DEL SERVICIO
            </div>
            
            <div class="ea-form-grid">
              <div class="ea-form-group">
                <label class="ea-label">N¬∞ Orden de Trabajo (OT/OTB) <span class="ea-required">*</span></label>
                <select id="field-ot" class="ea-select" required>
                  <option value="">Cargando √≥rdenes...</option>
                </select>
                <input type="hidden" id="field-tipo-orden">
              </div>
              <div class="ea-form-group">
                <label class="ea-label">NOM / Servicio <span class="ea-required">*</span></label>
                <input type="text" id="field-nom" class="ea-input" list="nom-list" required placeholder="Escribe o selecciona..." autocomplete="off">
                <datalist id="nom-list"></datalist>
              </div>
            </div>

            <div class="ea-form-grid">
              <div class="ea-form-group full-width">
                <label class="ea-label" style="color: var(--primary);">N¬∞ DE INFORME (GENERADO AUTOM√ÅTICAMENTE)</label>
                <input type="text" id="field-num-informe" class="ea-input" readonly placeholder="Se generar√° al completar OT y NOM" style="font-size: 16px; text-align: center;">
              </div>
            </div>

            <div style="border-top: 1px dashed var(--border); margin: 25px 0;"></div>

            <div class="ea-form-grid">
              <div class="ea-form-group">
                <label class="ea-label">Cliente Inicial <span class="excel-cell-indicator">Excel D5</span> <span class="ea-required">*</span></label>
                <input type="text" id="field-cliente-inicial" class="ea-input" required placeholder="Raz√≥n Social Origen">
              </div>
              <div class="ea-form-group">
                <label class="ea-label">Cliente Final / Sucursal <span class="excel-cell-indicator">Excel D6</span> <span class="ea-required">*</span></label>
                <input type="text" id="field-cliente-final" class="ea-input" required placeholder="Sucursal o Empresa Destino">
              </div>
            </div>

            <div class="ea-form-grid">
              <div class="ea-form-group">
                <label class="ea-label">Solicitante <span class="excel-cell-indicator">Excel D3</span></label>
                <input type="text" id="field-solicitante" class="ea-input">
              </div>
              <div class="ea-form-group">
                <label class="ea-label">RFC <span class="excel-cell-indicator">Excel D7</span></label>
                <input type="text" id="field-rfc" class="ea-input">
              </div>
              <div class="ea-form-group">
                <label class="ea-label">Tel√©fono <span class="excel-cell-indicator">Excel I7</span></label>
                <input type="text" id="field-tel" class="ea-input">
              </div>
              <div class="ea-form-group full-width">
                <label class="ea-label">Direcci√≥n Centro de Trabajo <span class="excel-cell-indicator">Excel D11</span></label>
                <input type="text" id="field-dir" class="ea-input">
              </div>
            </div>

            <div class="ea-form-grid">
              <div class="ea-form-group">
                <label class="ea-label">Fecha Emisi√≥n OT (Visita) <span class="ea-required">*</span></label>
                <input type="date" id="field-fecha" class="ea-input" required>
              </div>
              <div class="ea-form-group">
                <label class="ea-label">Fecha Compromiso (+15 d√≠as)</label>
                <input type="date" id="field-entrega" class="ea-input" readonly>
              </div>
              <div class="ea-form-group full-width">
                <label class="ea-label">Responsable del Informe <span class="ea-required">*</span></label>
                <select id="field-responsable" class="ea-select" required>
                  <option value="">Seleccione responsable...</option>
                  <option value="EDUARDO CAMPOS">EDUARDO CAMPOS</option>
                  <option value="EDUWIN IVAN">EDUWIN IVAN</option>
                  <option value="MARTIN LUNA">MARTIN LUNA</option>
                  <option value="JIMMY AYALA">JIMMY AYALA</option>
                </select>
              </div>
            </div>
          </div>

          <div class="ea-section step-locked" id="card-paso3" style="border-bottom: none;">
            <div class="ea-section-header">
              <span class="ea-step-badge">PASO 3</span> DOCUMENTACI√ìN DIGITAL
            </div>
            
            <div class="ea-form-grid">
              <div class="ea-form-group">
                <label class="ea-label">1. Orden de Trabajo (PDF)</label>
                <div class="ea-file-zone"><input type="file" id="up-ot" accept=".pdf"></div>
              </div>
              
              <div class="ea-form-group">
                <label class="ea-label">2. HDC (Hojas de Campo)</label>
                <div class="ea-file-zone"><input type="file" id="up-campo" multiple accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls"></div>
              </div>
              
              <div class="ea-form-group">
                <label class="ea-label">3. Croquis</label>
                <div class="ea-file-zone"><input type="file" id="up-croquis" multiple accept=".pdf,.jpg,.jpeg,.png,.dwg"></div>
              </div>
              
              <div class="ea-form-group">
                <label class="ea-label">4. Fotos</label>
                <div class="ea-file-zone"><input type="file" id="up-fotos" multiple accept=".pdf,.jpg,.jpeg,.png,.zip"></div>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
              <button id="btn-enviar" class="ea-btn-submit" onclick="enviarTodo()" disabled>üöÄ Generar Expediente y Enviar</button>
            </div>

            <div id="main-loader" class="loader">
              <div class="spinner"></div>
              <p style="margin-top:15px; color:var(--primary); font-weight:bold;" id="loader-message">Procesando y subiendo archivos...</p>
            </div>
            <div id="main-status" class="status-box" style="display:none; margin-top:20px; text-align:center;"></div>
          </div>

        </div>
      </div>
    </div>


    <div id="section-tablero" class="section-tab">
      
      <div class="kpi-grid">
        <div class="kpi-card" data-metric="todos" onclick="filtrarPorMetrica('todos')">
          <div class="kpi-label">Total Informes</div>
          <div class="kpi-value" id="kpi-total">0</div>
        </div>
        <div class="kpi-card" data-metric="no-iniciado" onclick="filtrarPorMetrica('no-iniciado')">
          <div class="kpi-label">‚ö™ No Iniciados</div>
          <div class="kpi-value" id="kpi-no-iniciado" style="color: var(--muted);">0</div>
        </div>
        <div class="kpi-card" data-metric="activos" onclick="filtrarPorMetrica('activos')">
          <div class="kpi-label">üîµ En Proceso</div>
          <div class="kpi-value" id="kpi-activos" style="color: #3498db;">0</div>
        </div>
        <div class="kpi-card" data-metric="en-tiempo" onclick="filtrarPorMetrica('en-tiempo')">
          <div class="kpi-label">üü¢ En Tiempo</div>
          <div class="kpi-value" id="kpi-tiempo" style="color: #27ae60;">0</div>
        </div>
        <div class="kpi-card" data-metric="vencidos" onclick="filtrarPorMetrica('vencidos')">
          <div class="kpi-label">üî¥ Vencidos</div>
          <div class="kpi-value" id="kpi-vencidos" style="color: #e74c3c;">0</div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <h3 style="color: var(--primary); margin:0;">üìã Base de Datos de Informes (<span id="table-count">0</span>)</h3>
          <div>
            <button onclick="limpiarFiltros()" style="padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">üîÑ Limpiar</button>
            <button onclick="exportarTablero()" style="padding: 6px 12px; border: none; background: var(--primary); color: white; border-radius: 4px; cursor: pointer;">üì• Excel</button>
          </div>
        </div>
        
        <div class="filter-bar">
          <input type="text" id="filter-search" placeholder="üîç Buscar OT, Informe, Cliente...">
          <select id="filter-estatus">
            <option value="">Todos los Estatus</option>
            <option value="NO INICIADO">No Iniciado</option>
            <option value="EN PROCESO">En Proceso</option>
            <option value="PARA REVISION">Para Revisi√≥n</option>
            <option value="FINALIZADO">Finalizado</option>
          </select>
          <select id="filter-vencimiento">
            <option value="">Todos los Vencimientos</option>
            <option value="vencidos">üî¥ Vencidos</option>
            <option value="proximos">üü† En l√≠mite (0-7 d√≠as)</option>
            <option value="en-plazo">üü¢ En tiempo</option>
          </select>
        </div>

        <div style="overflow-x: auto; max-height: 600px;">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Informe / OT</th>
                <th>NOM / Fecha</th>
                <th>Cliente Inicial</th>
                <th>Cliente Final (Sucursal)</th>
                <th>Responsable</th>
                <th>Estatus Operativo</th>
                <th>SLA</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablero-box">
              <tr><td colspan="8"><div class="loader" style="display:block;"><div class="spinner"></div></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>
  </div>

<script>
  // =====================================================
  // SCRIPT PRINCIPAL - SISTEMA DE EXPEDIENTES
  // =====================================================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzoiMdL4-TVLaOlfvD7IptBJ7aGiFX0txHv7RYpxJXEkBCl0XUBGHoavN_Xf5eXzRCB/exec';
  const MAX_BATCH_SIZE = 15 * 1024 * 1024;

  let perfilDataFile = null;
  let allTableroData = [];
  let filtroMetricaActivo = null;

  // 1. CARGA DE ORDENES DE TRABAJO
  function cargarOrdenesDisponibles() {
    jsonp(`${SCRIPT_URL}?action=getOrdenes`, (result) => {
      const select = document.getElementById('field-ot');
      select.innerHTML = '<option value="">Seleccione una OT...</option>';
      if (result && result.success && result.data) {
        result.data.forEach(orden => {
          const option = document.createElement('option');
          option.value = orden.ot;
          option.dataset.clienteInicial = orden.clienteInicial || orden.cliente || '';
          option.dataset.clienteFinal = orden.clienteFinal || ''; 
          option.textContent = `${orden.ot} - ${option.dataset.clienteInicial}`;
          select.appendChild(option);
        });
      }
    });
  }

  document.getElementById('field-ot').addEventListener('change', function() {
    detectarTipoOrden();
    const selected = this.selectedOptions[0];
    if (selected && selected.value !== "") {
      document.getElementById('field-cliente-inicial').value = selected.dataset.clienteInicial || '';
      if(!document.getElementById('field-cliente-final').value) {
        document.getElementById('field-cliente-final').value = selected.dataset.clienteFinal || '';
      }
    } else {
      document.getElementById('field-cliente-inicial').value = '';
    }
    validarProgreso();
  });

  const NOMS_OT = ['011', '015', '022', '024', '025', '081'];
  const NOMS_OTB = ['001', '002', '004', '005', '006', '009', '017', '018', '019', '020', '026', '027', '029', '030', '033', '035', '036', 'LEY-SILLA', 'PIPC'];

  // 2. L√ìGICA DE EXCEL
  document.getElementById('excelFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const infoBox = document.getElementById('perfil-status-box');
    const infoText = document.getElementById('info-perfil-quick');

    if (!file) {
      perfilDataFile = null;
      infoBox.className = 'status-box box-warning';
      infoText.innerHTML = '‚ö†Ô∏è Sin cargar - Sube el Excel para desbloquear los siguientes pasos.';
      validarProgreso(); return;
    }

    perfilDataFile = file;
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const getVal = (c) => ws[c] ? ws[c].v : '';

        document.getElementById('field-solicitante').value = getVal('D3');
        document.getElementById('field-cliente-inicial').value = getVal('D5');
        document.getElementById('field-cliente-final').value = getVal('D6');
        document.getElementById('field-rfc').value = getVal('D7');
        document.getElementById('field-tel').value = getVal('I7');
        document.getElementById('field-dir').value = getVal('D11');

        infoBox.className = 'status-box box-success';
        infoText.innerHTML = `‚úÖ <strong>${file.name}</strong> procesado correctamente. Pasos desbloqueados.`;
        validarProgreso();
      } catch (err) { alert('Error al leer el Excel. Verifica el formato.'); }
    };
    reader.readAsArrayBuffer(file);
  });

  // IDENTIFICAR OT vs OTB
  function detectarTipoOrden() {
    const ot = document.getElementById('field-ot').value.trim().toUpperCase();
    const tipo = document.getElementById('field-tipo-orden');
    const datalist = document.getElementById('nom-list');
    
    // Se extrae expl√≠citamente si es OTB u OT. Esta variable se manda al backend.
    tipo.value = ot.startsWith('OTB') ? 'OTB' : (ot.startsWith('OT') ? 'OT' : '');
    const noms = tipo.value === 'OTB' ? NOMS_OTB : (tipo.value === 'OT' ? NOMS_OT : []);

    datalist.innerHTML = '';
    noms.forEach(n => datalist.appendChild(new Option(n, n)));
    document.getElementById('field-nom').value = '';
    generarNumeroInforme();
  }

  function generarNumeroInforme() {
    const ot = document.getElementById('field-ot').value.trim().toUpperCase();
    const nom = document.getElementById('field-nom').value.trim();
    const field = document.getElementById('field-num-informe');

    if (!ot || !nom) { field.value = ''; return; }
    
    // Identificador para tu backend: OT vs OTB
    const tipoOrden = ot.startsWith('OTB') ? 'OTB' : 'OT';

    // Generador visual (se actualizar√° con el valor real del backend si se obtiene a tiempo)
    field.value = 'Generando formato...';
    
    // Llamada al backend para el consecutivo exacto
    const match = ot.match(/OT[B]?(\d{2})-(\d{4})/);
    if (!match) return;

    jsonp(`${SCRIPT_URL}?action=getConsecutivo&anio=${match[1]}&mes=${match[2].substring(0,2)}&nom=${encodeURIComponent(nom)}&tipo=${tipoOrden}`, 
      (res) => { field.value = (res && res.success) ? res.numeroInforme : `[Autom√°tico al enviar]`; }, 
      () => { field.value = `[Autom√°tico al enviar]`; }
    );
  }

  document.getElementById('field-nom').addEventListener('input', () => { generarNumeroInforme(); validarProgreso(); });
  document.getElementById('field-cliente-final').addEventListener('input', () => validarProgreso());
  
  document.getElementById('field-fecha').addEventListener('change', function() {
    if (this.value) {
      const date = new Date(this.value); date.setDate(date.getDate() + 15);
      document.getElementById('field-entrega').value = date.toISOString().split('T')[0];
    }
    validarProgreso();
  });

  function changeTab(tabId, e) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section-tab').forEach(s => s.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById('section-' + tabId).classList.add('active');
    if (tabId === 'tablero') cargarTablero();
  }

  // 3. ENV√çO AL DRIVE / SHEETS
  async function enviarTodo() {
    const btn = document.getElementById('btn-enviar');
    const ot = document.getElementById('field-ot').value.trim();
    const nom = document.getElementById('field-nom').value.trim();
    
    if(allTableroData && allTableroData.find(r => String(r.ot).toUpperCase() === ot.toUpperCase() && String(r.nom).toUpperCase() === nom.toUpperCase())) {
      alert(`‚ö†Ô∏è Ya existe un expediente registrado para la OT "${ot}" con el servicio "${nom}".`); return;
    }

    if (!confirm(`¬øConfirmar creaci√≥n de expediente para OT: ${ot} - ${nom}?`)) return;

    btn.disabled = true;
    document.getElementById('main-loader').style.display = 'block';
    document.getElementById('main-status').style.display = 'none';

    let totalBytes = 0; const allFiles = [];
    const otPdf = document.getElementById('up-ot').files[0];
    
    // Empaquetado de los 4 Archivos Solicitados
    if (otPdf) { allFiles.push({ file: otPdf, category: 'ORDEN_TRABAJO', size: otPdf.size }); totalBytes += otPdf.size; }
    if (perfilDataFile) { allFiles.push({ file: perfilDataFile, category: 'PERFIL_DATOS', size: perfilDataFile.size }); totalBytes += perfilDataFile.size; }
    for (const f of document.getElementById('up-campo').files) { allFiles.push({ file: f, category: 'HOJAS_CAMPO', size: f.size }); totalBytes += f.size; }
    for (const f of document.getElementById('up-croquis').files) { allFiles.push({ file: f, category: 'CROQUIS', size: f.size }); totalBytes += f.size; }
    for (const f of document.getElementById('up-fotos').files) { allFiles.push({ file: f, category: 'FOTOS', size: f.size }); totalBytes += f.size; }

    const fileToB64 = (file, cat) => new Promise((resolve, reject) => {
      const rd = new FileReader(); rd.onerror = () => reject(new Error('Lectura fallida'));
      rd.onload = () => resolve({ name: file.name, type: file.type, content: rd.result.split(',')[1], category: cat });
      rd.readAsDataURL(file);
    });

    try {
      const basePayload = {
        action: 'createExpediente',
        data: {
          ot, nom, 
          numInforme: document.getElementById('field-num-informe').value,
          clienteInicial: document.getElementById('field-cliente-inicial').value.trim(),
          clienteFinal: document.getElementById('field-cliente-final').value.trim(),
          sucursal: document.getElementById('field-cliente-final').value.trim(), 
          fecha: document.getElementById('field-fecha').value,
          entrega: document.getElementById('field-entrega').value,
          
          // Se env√≠a la validaci√≥n de si es OT u OTB para tu backend
          tipoOrden: document.getElementById('field-tipo-orden').value,
          
          solicitante: document.getElementById('field-solicitante').value.trim(),
          rfc: document.getElementById('field-rfc').value.trim(),
          telefono: document.getElementById('field-tel').value.trim(),
          direccion: document.getElementById('field-dir').value.trim(),
          responsable: document.getElementById('field-responsable').value,
          estatus: 'NO INICIADO'
        },
        files: [] 
      };

      if (totalBytes > MAX_BATCH_SIZE) {
        const priority = allFiles.filter(f => f.category === 'ORDEN_TRABAJO' || f.category === 'PERFIL_DATOS');
        const others = allFiles.filter(f => f.category !== 'ORDEN_TRABAJO' && f.category !== 'PERFIL_DATOS');

        for (const item of priority) basePayload.files.push(await fileToB64(item.file, item.category));
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(basePayload) });
        await new Promise(r => setTimeout(r, 3000));

        let currentBatch = [], currentSize = 0, batches = [];
        for (const item of others) {
          if (currentSize + item.size > MAX_BATCH_SIZE && currentBatch.length > 0) { batches.push(currentBatch); currentBatch = []; currentSize = 0; }
          currentBatch.push(item); currentSize += item.size;
        }
        if (currentBatch.length > 0) batches.push(currentBatch);

        for (let b of batches) {
          const batchPayload = { action: 'addFilesToExpediente', ot: ot, files: [] };
          for (const item of b) batchPayload.files.push(await fileToB64(item.file, item.category));
          await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(batchPayload) });
          await new Promise(r => setTimeout(r, 2000));
        }
      } else {
        for (const item of allFiles) basePayload.files.push(await fileToB64(item.file, item.category));
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(basePayload) });
      }

      setTimeout(() => {
        document.getElementById('main-loader').style.display = 'none';
        const status = document.getElementById('main-status');
        status.style.display = 'block'; status.className = 'status-box box-success';
        status.innerHTML = `‚úÖ Expediente procesado exitosamente. Revisa el Tablero.`;
        cargarTablero(); limpiarFormulario();
      }, 3000);

    } catch (err) {
      document.getElementById('main-loader').style.display = 'none';
      alert(`‚ùå Error: ${err.message}`); btn.disabled = false;
    }
  }

  function limpiarFormulario() {
    document.querySelectorAll('input:not([type="hidden"])').forEach(i => i.value = '');
    document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    perfilDataFile = null; validarProgreso();
    document.getElementById('perfil-status-box').className = 'status-box box-warning';
    document.getElementById('info-perfil-quick').innerHTML = '‚ö†Ô∏è Sin cargar - Sube el Excel';
  }

  // 4. TABLERO DE INFORMES
  function calcularDiasVencimiento(fechaEntrega) {
    if (!fechaEntrega) return null;
    const hoy = new Date(); hoy.setHours(0, 0, 0, 0);
    const entrega = new Date(fechaEntrega); entrega.setHours(0, 0, 0, 0);
    return Math.ceil((entrega - hoy) / 86400000);
  }

  function cargarTablero() {
    jsonp(`${SCRIPT_URL}?action=getTablero`, (result) => {
      if (result && result.success) {
        allTableroData = result.data || [];
        aplicarFiltros();
      }
    });
  }

  function renderTablero(data) {
    const box = document.getElementById('tablero-box');
    calcularKPIs(data);

    if (!data || data.length === 0) { box.innerHTML = `<tr><td colspan="8" style="text-align:center;">No hay expedientes</td></tr>`; return; }

    let html = '';
    data.forEach((r) => {
      const estatus = (r.estatus || 'NO INICIADO').toUpperCase();
      const dias = calcularDiasVencimiento(r.fechaEntrega);
      
      let slaChip = `<span class="chip chip-gray">Sin SLA</span>`;
      if(estatus.includes('FINALIZADO')) slaChip = `<span class="chip chip-green">Entregado</span>`;
      else if(dias !== null) {
        if(dias < 0) slaChip = `<span class="chip chip-red">Vencido (${Math.abs(dias)}d)</span>`;
        else if(dias <= 7) slaChip = `<span class="chip chip-yellow">L√≠mite (${dias}d)</span>`;
        else slaChip = `<span class="chip chip-green">En tiempo (${dias}d)</span>`;
      }

      const cInicial = r.clienteInicial || r.cliente || '-';
      const cFinal = r.clienteFinal || r.sucursal || '-';

      html += `<tr>
        <td><strong>${r.numInforme || '-'}</strong><br><span style="color:var(--muted); font-size:10px;">${r.ot}</span></td>
        <td><strong>${r.nom || '-'}</strong><br><span style="color:var(--muted); font-size:10px;">${r.fecha || '-'}</span></td>
        <td>${cInicial}</td>
        <td>${cFinal}</td>
        <td>
          <select style="padding:4px;" onchange="cambiarDatoRapido('${r.ot}', 'responsable', this.value)">
            <option value="" ${!r.responsable ? 'selected' : ''}>-</option>
            <option value="EDUARDO CAMPOS" ${r.responsable==='EDUARDO CAMPOS'?'selected':''}>Eduardo C.</option>
            <option value="EDUWIN IVAN" ${r.responsable==='EDUWIN IVAN'?'selected':''}>Eduwin I.</option>
            <option value="MARTIN LUNA" ${r.responsable==='MARTIN LUNA'?'selected':''}>Mart√≠n L.</option>
          </select>
        </td>
        <td>
          <select style="padding:4px;" onchange="cambiarDatoRapido('${r.ot}', 'estatus', this.value)">
            <option value="NO INICIADO" ${estatus==='NO INICIADO'?'selected':''}>No Iniciado</option>
            <option value="EN PROCESO" ${estatus==='EN PROCESO'?'selected':''}>En Proceso</option>
            <option value="PARA REVISION" ${estatus==='PARA REVISION'?'selected':''}>En Revisi√≥n</option>
            <option value="FINALIZADO" ${estatus==='FINALIZADO'?'selected':''}>Finalizado</option>
          </select>
        </td>
        <td>${slaChip}</td>
        <td>
          <a href="${r.linkDrive || '#'}" target="_blank" style="text-decoration:none; background:#1e5a3e; color:white; padding:4px 8px; border-radius:3px; font-size:10px;">üìÅ Drive</a>
        </td>
      </tr>`;
    });
    box.innerHTML = html;
    document.getElementById('table-count').textContent = data.length;
  }

  function aplicarFiltros() {
    const search = document.getElementById('filter-search').value.toLowerCase();
    const estatus = document.getElementById('filter-estatus').value;
    
    let filtered = allTableroData.filter(r => {
      const eNorm = (r.estatus || 'NO INICIADO').toUpperCase();
      if(filtroMetricaActivo) {
          if(filtroMetricaActivo === 'no-iniciado' && eNorm !== 'NO INICIADO') return false;
          if(filtroMetricaActivo === 'activos' && (eNorm === 'FINALIZADO' || eNorm === 'CANCELADO' || eNorm === 'NO INICIADO')) return false;
      }
      const matchSearch = !search || Object.values(r).join(' ').toLowerCase().includes(search);
      const matchEstatus = !estatus || eNorm === estatus;
      return matchSearch && matchEstatus;
    });
    renderTablero(filtered);
  }

  function filtrarPorMetrica(metrica) {
    filtroMetricaActivo = metrica === 'todos' ? null : metrica;
    aplicarFiltros();
  }

  function calcularKPIs(data) {
    let noIniciado=0, activos=0, tiempo=0, vencidos=0;
    allTableroData.forEach(r => {
      const e = (r.estatus || 'NO INICIADO').toUpperCase();
      if(e === 'NO INICIADO') noIniciado++;
      else if(e !== 'FINALIZADO' && e !== 'CANCELADO') activos++;
      
      const vState = calcularDiasVencimiento(r.fechaEntrega);
      if(vState !== null && e !== 'FINALIZADO') {
        if(vState < 0) vencidos++; else tiempo++;
      }
    });
    document.getElementById('kpi-total').textContent = allTableroData.length;
    document.getElementById('kpi-no-iniciado').textContent = noIniciado;
    document.getElementById('kpi-activos').textContent = activos;
    document.getElementById('kpi-tiempo').textContent = tiempo;
    document.getElementById('kpi-vencidos').textContent = vencidos;
  }

  // 5. UTILIDADES Y VALIDACI√ìN
  function validarProgreso() {
    const tienePerfil = perfilDataFile !== null;
    const card2 = document.getElementById('card-paso2');
    const card3 = document.getElementById('card-paso3');
    const btn = document.getElementById('btn-enviar');

    if (tienePerfil) card2.classList.remove('step-locked');
    else { card2.classList.add('step-locked'); card3.classList.add('step-locked'); btn.disabled = true; return; }

    const cFinal = document.getElementById('field-cliente-final').value.trim();
    const listoPaso2 = document.getElementById('field-ot').value && document.getElementById('field-nom').value && cFinal && document.getElementById('field-fecha').value;
    
    if (listoPaso2) {
      card3.classList.remove('step-locked');
      btn.disabled = false;
    } else {
      card3.classList.add('step-locked'); btn.disabled = true;
    }
  }

  function jsonp(url, success, error) {
    const cb = 'cb_' + Date.now() + Math.floor(Math.random() * 100);
    const script = document.createElement('script');
    script.src = `${url}${url.includes('?')?'&':'?'}callback=${cb}`;
    window[cb] = data => { success(data); document.body.removeChild(script); delete window[cb]; };
    script.onerror = () => { if(error) error(); };
    document.body.appendChild(script);
  }

  document.addEventListener('DOMContentLoaded', () => {
    cargarOrdenesDisponibles();
    ['filter-search', 'filter-estatus', 'filter-vencimiento'].forEach(id => { document.getElementById(id).addEventListener('change', aplicarFiltros); });
    document.getElementById('filter-search').addEventListener('input', aplicarFiltros);
  });
</script>
</body>
</html>
